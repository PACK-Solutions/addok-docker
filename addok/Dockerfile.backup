# --- Enhanced Addok Container v2.0 - FIXED ---
# Multi-stage build with proper C++ compilation support

# Build stage
FROM python:3.10-slim AS builder

WORKDIR /build

# Install ALL build dependencies (including C++ compiler)
RUN apt-get update && \
    apt-get install -y \
    gcc \
    g++ \
    wget \
    unzip \
    build-essential \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy source code from addok-src
COPY ./addok-src ./addok-src

WORKDIR /build/addok-src

# Build the source distribution
RUN python3 setup.py sdist

# Pre-compile all Python packages in builder stage
RUN pip wheel --no-cache-dir \
    cython \
    ./dist/addok-*.tar.gz \
    addok-fr==1.0.1 \
    addok-france==1.1.3 \
    addok-csv==1.0.1 \
    addok-sqlite-store==1.0.1 \
    gunicorn==20.1.0 \
    ddtrace \
    python-geohash==0.8.5 \
    --wheel-dir /build/wheels

# --- Final production image ---
FROM python:3.10-slim

# Create non-root user
RUN groupadd -r addok && useradd --no-log-init -r -g addok addok

WORKDIR /app

# Install ONLY runtime dependencies (no build tools)
RUN apt-get update && \
    apt-get install -y \
    wget \
    unzip \
    netcat-traditional \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy pre-compiled wheels from builder
COPY --from=builder /build/wheels /tmp/wheels

# Install all packages from pre-compiled wheels
RUN pip install --no-cache-dir --find-links /tmp/wheels \
    cython \
    addok \
    addok-fr==1.0.1 \
    addok-france==1.1.3 \
    addok-csv==1.0.1 \
    addok-sqlite-store==1.0.1 \
    gunicorn==20.1.0 \
    ddtrace \
    python-geohash==0.8.5 \
    && rm -rf /tmp/wheels

# Create directories with proper ownership
RUN mkdir -p /data /logs /etc/addok /tmp/addok-download \
    && chown -R addok:addok /data /logs /etc/addok /tmp/addok-download

# Environment variables
ENV ADDOK_CONFIG_MODULE=/etc/addok/addok.patched.conf
ENV REDIS_HOST=redis
ENV REDIS_PORT=6379
ENV REDIS_DB_INDEXES=0
ENV SQLITE_DB_PATH=/data/addok.db

# Datadog tracing
ENV DD_SERVICE="addok"
ENV DD_ENV="production"
ENV DD_VERSION="2.0.0"
ENV DD_TRACE_ENABLED="true"
ENV DD_LOGS_INJECTION="true"

# Application configuration
ENV WORKERS=2
ENV WORKER_TIMEOUT=30
ENV LOG_QUERIES=0
ENV LOG_NOT_FOUND=0
ENV SLOW_QUERIES=500

# Pre-indexed data configuration
ENV PRE_INDEXED_DATA_URL="https://adresse.data.gouv.fr/data/ban/adresses/latest/addok/addok-france-bundle.zip"
ENV DOWNLOAD_TIMEOUT=300
ENV MAX_DOWNLOAD_RETRIES=3

# Security labels
LABEL com.datadoghq.tags.service="addok"
LABEL com.datadoghq.tags.env="production"
LABEL com.datadoghq.tags.version="2.0.0"
LABEL org.opencontainers.image.title="Addok Geocoding Service"
LABEL org.opencontainers.image.version="2.0.0"
LABEL org.opencontainers.image.description="Production-ready French address geocoding service"

# Copy enhanced entrypoint script
COPY docker-entrypoint.sh /bin/docker-entrypoint.sh
RUN chmod +x /bin/docker-entrypoint.sh

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=300s --retries=3 \
    CMD curl -f http://localhost:7878/search?q=test || exit 1

# Security: Run as non-root user
USER addok

VOLUME ["/data"]
EXPOSE 7878

ENTRYPOINT ["/bin/docker-entrypoint.sh"]
